---
import type { GetStaticPaths } from 'astro'
import Layout from '~/layouts/Layout.astro'
import { TagsGroup } from '~/utils'
import Pagination from '~/components/Pagination.astro'
import siteConfig from '~/site.config'
import PostPreview from '~/components/PostPreview.astro'
import PageHeader from '~/components/PageHeader.astro'

// Note: Pagination like '/', '/2', '/3' only works with spread param like [...page]
export const getStaticPaths = (async ({ paginate }) => {
  const tagsGroup = await TagsGroup.build()
  const paths = []

  for (const tags of tagsGroup.collations) {
    if (!tags.entries.length) continue
    const pages = paginate(tags.entries.reverse(), {
      pageSize: siteConfig.pageSize,
    })
    pages.forEach((page) => {
      const params = { ...(page.params ?? {}) }
      params.tag = String(tags.titleSlug || '').trim()
      if (!params.tag) return
      paths.push({
        ...page,
        params,
        props: { ...(page.props ?? {}), tagTitle: tags.title },
      })
    })
  }

  return paths
}) satisfies GetStaticPaths

const { page, tagTitle } = Astro.props
const pageTitle =
  `Tag: ${tagTitle}` + (page.currentPage > 1 ? ` - Page ${page.currentPage}` : '')
---

<Layout title={pageTitle} description={`All posts tagged with ${tagTitle}`}>
  <div class="mt-2 sm:mt-0">
    <PageHeader titlePieces={['tags', tagTitle]} />
    {page.data.map((post) => <PostPreview post={post} />)}
    <Pagination
      prevLink={page.url.prev ? encodeURI(page.url.prev) : undefined}
      prevText="Newer Posts"
      nextLink={page.url.next ? encodeURI(page.url.next) : undefined}
      nextText="Older Posts"
    />
  </div>
</Layout>
